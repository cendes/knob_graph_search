#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "list.h"
#include "hash_map.h"
#include "var_search.h"
#include "database.h"

static FILE* database_file;

static char* read_database_string();

static struct list* read_string_list();

static void write_database_string(const char* string);

static void write_string_list(struct list* string_list);

hash_map database_read(const char* filename) {
  database_file = fopen(filename, "w+");
  if (database_file == NULL) {
    perror("Could not open database: ");
    return NULL;
  }

  hash_map func_var_database = map_create();
  char* func;
  do {
    func = read_database_string();
    if (func != NULL) {
      char* var = read_database_string();
      struct list* var_refs = read_string_list();
      struct list* full_var_refs = read_string_list();

      struct func_var_entry* entry =
        (struct func_var_entry*) malloc(sizeof(struct func_var_entry));
      entry->var_refs = var_refs;
      entry->full_var_refs = full_var_refs;
      entry->locked = false;
      
      hash_map var_map;
      if (map_contains(func_var_database, func)) {
        var_map = (hash_map) map_get(func_var_database, func);
      } else {
        var_map = map_create();
        map_insert(func_var_database, func, var_map);
      }
      map_insert(var_map, var, entry);
    }
  } while (func != NULL);

  return func_var_database;
}

static char* read_database_string() {
  size_t string_len;
  size_t bytes_read = fread(&string_len, sizeof(size_t), 1, database_file);
  if (bytes_read == 0) {
    return NULL;
  }
  
  char* string = (char*) malloc(string_len + 1);
  fread(string, 1, string_len, database_file);
  string[string_len] = '\0';
  
  return string;
}

static struct list* read_string_list() {
  size_t num_strings;
  fread(&num_strings, sizeof(size_t), 1, database_file);
  struct list* string_list = list_create();
  for (size_t i = 0; i < num_strings; i++) {
    char* string = read_database_string();
    list_append(string_list, string);
  }

  return string_list;
}

void database_write_entry(const char* func, const char* var,
                          struct func_var_entry* entry) {
  write_database_string(func);
  write_database_string(var);
  write_string_list(entry->var_refs);
  write_string_list(entry->full_var_refs);
  
  int ret = fflush(database_file);
  if (ret != 0) {
    perror("Database write failed: ");
  }
}

static void write_database_string(const char* string) {
  size_t string_len = strlen(string);
  fwrite(&string_len, sizeof(size_t), 1, database_file);
  fwrite(string, 1, string_len, database_file);
}

static void write_string_list(struct list* string_list) {
  if (string_list == NULL) {
    size_t zero = 0;
    fwrite(&zero, sizeof(size_t), 1, database_file);
    return;
  }
  
  fwrite(&string_list->len, sizeof(size_t), 1, database_file);
  for (struct list_node* curr = string_list->head; curr != NULL; curr = curr->next) {
    size_t string_len = strlen((char*) curr->payload);
    fwrite(&string_len, sizeof(size_t), 1, database_file);
    fwrite(curr->payload, 1, string_len, database_file);
  }
}
